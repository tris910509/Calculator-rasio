<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ISP Dashboard PRO ‚Äî Network, OLT & QoS</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{--sidebar-bg:#0d6efd;--sidebar-color:#fff;--card-radius:12px}
    body{background:#f4f6fb}
    .sidebar{min-height:100vh;background:var(--sidebar-bg);color:var(--sidebar-color)}
    .sidebar a{color:var(--sidebar-color);text-decoration:none}
    .card-compact{border-radius:var(--card-radius)}
    .small-muted{font-size:.85rem;color:#6c757d}
    .progress-label{font-weight:600}
    .nowrap{white-space:nowrap}
    .leaflet-container{height:240px;border-radius:8px}
    .theme-dark{background:#0b1220;color:#e6eef8}
    .theme-dark .card{background:#0f1724;color:#e6eef8}
    .theme-dark .sidebar{background:#061032}

    @media (max-width:991px){.sidebar{position:relative;min-height:auto}}
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <!-- SIDEBAR -->
    <nav class="col-lg-2 sidebar p-3 d-flex flex-column gap-3">
      <div class="d-flex align-items-center gap-2 mb-3">
        <div class="rounded-circle bg-white text-primary d-flex align-items-center justify-content-center" style="width:44px;height:44px">PRO</div>
        <div>
          <div class="fw-bold">ISP Dashboard PRO</div>
          <div class="small-muted">All-in-one Network Management</div>
        </div>
      </div>

      <div class="mt-2">
        <a href="#overview" class="d-block mb-2"><i class="bi bi-speedometer2"></i> Overview</a>
        <a href="#network" class="d-block mb-2"><i class="bi bi-wifi"></i> Network Ratio</a>
        <a href="#olt" class="d-block mb-2"><i class="bi bi-hdd-network"></i> OLT / PON</a>
        <a href="#qos" class="d-block mb-2"><i class="bi bi-activity"></i> QoS Monitor</a>
        <a href="#ont" class="d-block mb-2"><i class="bi bi-hdd"></i> ONT Status</a>
        <a href="#map" class="d-block mb-2"><i class="bi bi-geo-alt"></i> Customer Map</a>
        <a href="#reports" class="d-block mb-2"><i class="bi bi-file-earmark-text"></i> Reports</a>
        <a href="#admin" class="d-block mb-2"><i class="bi bi-people"></i> Admin</a>
      </div>

      <div class="mt-auto small-muted">
        Version PRO ‚Ä¢ Local Demo
      </div>
    </nav>

    <!-- MAIN -->
    <main class="col-lg-10 p-4">
      <!-- TOP BAR -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h3 class="mb-0">ISP Dashboard PRO</h3>
          <div class="small-muted">Realtime monitoring ‚Ä¢ OLT control ‚Ä¢ QoE & MOS</div>
        </div>
        <div class="d-flex gap-2 align-items-center">
          <div class="form-check form-switch me-2">
            <input class="form-check-input" type="checkbox" id="toggleTheme">
            <label class="form-check-label small-muted" for="toggleTheme">Dark Mode</label>
          </div>
          <button class="btn btn-outline-secondary" id="btnToggleMonitor"><i class="bi bi-play-fill"></i> Start Monitor</button>
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">Export</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="exportPdf">Export PDF</a></li>
              <li><a class="dropdown-item" href="#" id="exportXlsx">Export Excel</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- OVERVIEW CARDS -->
      <section id="overview" class="mb-4">
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card card-compact p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="small-muted">Total Bandwidth</div>
                  <div class="h5" id="overviewBandwidth">100 Mbps</div>
                </div>
                <i class="bi bi-collection-play text-primary" style="font-size:28px"></i>
              </div>
              <div class="mt-2 small-muted">Users: <span id="overviewUsers">50</span> ‚Ä¢ ONU: <span id="overviewOnu">500</span></div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card card-compact p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="small-muted">OLT Utilization</div>
                  <div class="h5" id="overviewOltPct">62%</div>
                </div>
                <i class="bi bi-box-seam text-warning" style="font-size:28px"></i>
              </div>
              <div class="mt-2">
                <div class="progress" style="height:10px">
                  <div id="overviewOltBar" class="progress-bar" role="progressbar" style="width:62%"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card card-compact p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="small-muted">QoS Overall</div>
                  <div class="h5" id="overviewQoS">Baik</div>
                </div>
                <i class="bi bi-graph-up text-success" style="font-size:28px"></i>
              </div>
              <div class="mt-2 small-muted">Latency: <span id="overviewLat">30ms</span> ‚Ä¢ Loss: <span id="overviewLoss">0.5%</span></div>
            </div>
          </div>

          <div class="col-md-3">
            <div class="card card-compact p-3 shadow-sm">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="small-muted">MOS (VoIP)</div>
                  <div class="h5" id="overviewMos">4.1</div>
                </div>
                <i class="bi bi-chat-dots text-info" style="font-size:28px"></i>
              </div>
              <div class="mt-2 small-muted">QoE: <span id="overviewQoe">Baik</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Panels grid -->
      <div class="row g-4">
        <!-- NETWORK RATIO -->
        <div id="network" class="col-xl-4 col-lg-6">
          <div class="card p-3 shadow-sm">
            <h5>üîß Network Ratio & Throughput</h5>
            <div class="row g-2 mt-2">
              <div class="col-12">
                <label class="form-label">Total Bandwidth (Mbps)</label>
                <input id="bandwidth" class="form-control" type="number" value="100">
              </div>
              <div class="col-6">
                <label class="form-label">Users</label>
                <input id="users" class="form-control" type="number" value="50">
              </div>
              <div class="col-6">
                <label class="form-label">Ideal per User (Mbps)</label>
                <input id="idealPerUser" class="form-control" type="number" value="2">
              </div>

              <div class="col-12 mt-2">
                <label class="form-label">Top 10 Users (simulated)</label>
                <div id="topUsers" class="small-muted"></div>
              </div>

              <div class="col-12 text-end mt-2">
                <button class="btn btn-sm btn-primary" id="btnCalcNetwork">Calculate</button>
              </div>

              <div class="col-12 mt-3">
                <div id="networkResult"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- OLT / PON CONTROL -->
        <div id="olt" class="col-xl-4 col-lg-6">
          <div class="card p-3 shadow-sm">
            <h5>üü¶ OLT / PON Management</h5>

            <div class="row g-2 mt-2">
              <div class="col-6">
                <label class="form-label">OLT Ports</label>
                <input id="oltPorts" class="form-control" type="number" value="16">
              </div>
              <div class="col-6">
                <label class="form-label">ONU per Port</label>
                <select id="onuPerPort" class="form-select">
                  <option value="64">64</option>
                  <option value="128">128</option>
                </select>
              </div>

              <div class="col-12 mt-2">
                <label class="form-label">Total ONU Terpasang</label>
                <input id="onuInstalled" class="form-control" type="number" value="500">
              </div>

              <div class="col-12 mt-3 d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="btnUpdateOlt">Update OLT</button>
                <button class="btn btn-sm btn-outline-warning" id="btnSimIncrease">Simulate +10 ONU</button>
                <button class="btn btn-sm btn-outline-danger" id="btnSimSpike">Simulate Fault Spike</button>
              </div>

              <div class="col-12 mt-3">
                <canvas id="oltPie" height="160"></canvas>
              </div>

              <div class="col-12 mt-2 small-muted">
                <div class="d-flex justify-content-between">
                  <div class="progress-label">Capacity</div>
                  <div id="oltCapText">1024 ONU</div>
                </div>
                <div class="progress mt-2" style="height:12px">
                  <div id="oltCapBar" class="progress-bar" role="progressbar" style="width:48%"></div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- QoS MONITOR -->
        <div id="qos" class="col-xl-4 col-lg-12">
          <div class="card p-3 shadow-sm">
            <h5>üì° QoS PRO Monitor</h5>

            <div class="row g-2 mt-2">
              <div class="col-4">
                <label class="form-label">Latency (ms)</label>
                <input id="latency" class="form-control" type="number" value="30">
              </div>
              <div class="col-4">
                <label class="form-label">Jitter (ms)</label>
                <input id="jitter" class="form-control" type="number" value="5">
              </div>
              <div class="col-4">
                <label class="form-label">Packet Loss (%)</label>
                <input id="packetLoss" class="form-control" type="number" value="0.5" step="0.1">
              </div>

              <div class="col-12 mt-2 d-flex gap-2">
                <button class="btn btn-sm btn-success" id="btnApplyQos">Apply</button>
                <button class="btn btn-sm btn-outline-secondary" id="btnRandomQos">Randomize</button>
                <button class="btn btn-sm btn-info" id="btnCalcMos">Calc MOS</button>
              </div>

              <div class="col-12 mt-3">
                <canvas id="qosChart" height="140"></canvas>
              </div>

              <div class="col-12 mt-2 small-muted">Last update: <span id="qosLast">-</span></div>
            </div>

          </div>
        </div>

        <!-- ONT STATUS -->
        <div id="ont" class="col-12">
          <div class="card p-3 shadow-sm">
            <h5>üìü ONT / Customer Devices Status</h5>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="table-responsive">
                  <table class="table table-sm" id="ontTable">
                    <thead>
                      <tr><th>ONT ID</th><th>Customer</th><th>Port</th><th>Status</th><th>Power</th><th>LOS</th></tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6">
                <h6>Sim Controls</h6>
                <div class="d-flex gap-2 mb-2">
                  <button class="btn btn-sm btn-outline-primary" id="btnAddRandomOnt">Add Random ONT</button>
                  <button class="btn btn-sm btn-outline-danger" id="btnSimDown">Simulate Down 5 ONT</button>
                  <button class="btn btn-sm btn-outline-success" id="btnRecoverAll">Recover All</button>
                </div>
                <div class="small-muted">Filter: <select id="filterStatus" class="form-select form-select-sm d-inline-block" style="width:140px"><option value="all">All</option><option value="online">Online</option><option value="offline">Offline</option></select></div>
              </div>
            </div>
          </div>
        </div>

        <!-- MAP -->
        <div id="map" class="col-12">
          <div class="card p-3 shadow-sm">
            <h5>üåê Customer Map</h5>
            <div id="mapContainer" class="mt-2"></div>
          </div>
        </div>

        <!-- REPORTS & ADMIN -->
        <div id="reports" class="col-12">
          <div class="card p-3 shadow-sm">
            <h5>üìÑ Reports & Management</h5>
            <div class="row g-2 mt-2">
              <div class="col-md-4">
                <button class="btn btn-outline-primary" id="btnExportPdf">Export Current Snapshot to PDF</button>
              </div>
              <div class="col-md-4">
                <button class="btn btn-outline-success" id="btnExportXlsx">Export History to Excel</button>
              </div>
              <div class="col-md-4 text-end">
                <button class="btn btn-outline-secondary" id="btnClearHistory">Clear History</button>
              </div>
            </div>
          </div>
        </div>

        <div id="admin" class="col-12">
          <div class="card p-3 shadow-sm">
            <h5>üîê Admin & Users</h5>
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">Create User</label>
                <input id="adminUser" class="form-control" placeholder="username">
              </div>
              <div class="col-md-4">
                <label class="form-label">Role</label>
                <select id="adminRole" class="form-select"><option value="admin">Admin</option><option value="operator">Operator</option></select>
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button class="btn btn-primary" id="btnCreateUser">Create</button>
              </div>
            </div>
            <div class="mt-3 small-muted">Users:</div>
            <ul id="userList" class="list-group list-group-flush"></ul>
          </div>
        </div>

      </div>

    </main>
  </div>
</div>

<!-- SCRIPTS -->
<script>
// Utilities
const by = id => document.getElementById(id);
const nowIso = () => new Date().toLocaleString();

// State
let monitoring = false; let monitorInterval=null;
let qosChart=null, oltPieChart=null, mapObj=null;
let qosData = {labels:[], latency:[], jitter:[], loss:[]};
let ontList = []; let users = [];

// Init
function init(){ initCharts(); initMap(); renderTopUsers(); loadUsers(); renderOntTable(); bindEvents(); pushQosSample(parseFloat(by('latency').value), parseFloat(by('jitter').value), parseFloat(by('packetLoss').value)); updateOlt(); }

// Charts
function initCharts(){
  const qosCtx = by('qosChart').getContext('2d');
  qosChart = new Chart(qosCtx, {
    type:'line', data:{labels:qosData.labels,datasets:[{label:'Latency (ms)',data:qosData.latency,tension:0.3,borderWidth:2,fill:false},{label:'Jitter (ms)',data:qosData.jitter,tension:0.3,borderWidth:2,fill:false},{label:'Packet Loss (%)',data:qosData.loss,tension:0.3,borderWidth:2,fill:false}]},
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
  });

  const pieCtx = by('oltPie').getContext('2d');
  oltPieChart = new Chart(pieCtx,{type:'doughnut',data:{labels:['Used ONU','Free ONU'],datasets:[{data:[500,524]}]},options:{cutout:'60%',plugins:{legend:{position:'bottom'}}}});
}

// Map
function initMap(){
  const el = document.createElement('div'); el.id='mapLeaf'; el.style.height='360px'; el.style.borderRadius='8px'; by('mapContainer').appendChild(el);
  mapObj = L.map('mapLeaf').setView([-6.200000,106.816666],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(mapObj);
  // add some random customers
  for(let i=0;i<20;i++){ const lat=-6.2 + (Math.random()-0.5)*0.4; const lon=106.8 + (Math.random()-0.5)*0.6; L.circleMarker([lat,lon],{radius:6}).bindPopup('Customer '+(i+1)).addTo(mapObj); }
}

// Network calc & Top Users
function calcNetwork(){ const bw=parseFloat(by('bandwidth').value)||0; const usersN=parseInt(by('users').value)||0; const ideal=parseFloat(by('idealPerUser').value)||1; if(!bw||!usersN){ by('networkResult').innerHTML='<div class="small-muted">Provide bandwidth & users</div>'; return;} const bwPerUser=(bw/usersN).toFixed(2); const totalIdeal=(ideal*usersN).toFixed(2); const util=((bw/totalIdeal)*100).toFixed(1); by('networkResult').innerHTML=`<div class="small-muted">BW/user: <b>${bwPerUser} Mbps</b></div><div class="small-muted">Total ideal: <b>${totalIdeal} Mbps</b></div><div class="small-muted">Utilization vs ideal: <b>${util}%</b></div>`; by('overviewBandwidth').innerText=bw+' Mbps'; by('overviewUsers').innerText=usersN; renderTopUsers(); }

function renderTopUsers(){ const list=[]; for(let i=0;i<10;i++){ list.push({id:'user'+(i+1),bw:Math.round(1+Math.random()*50)}); } list.sort((a,b)=>b.bw-a.bw); by('topUsers').innerHTML = list.map(u=>`<div>${u.id}: ${u.bw} Mbps</div>`).join(''); }

// OLT
function updateOlt(){ const ports=parseInt(by('oltPorts').value)||0; const per=parseInt(by('onuPerPort').value)||64; const installed=parseInt(by('onuInstalled').value)||0; const cap=ports*per; const used=installed; const pct = cap? (used/cap)*100:0; oltPieChart.data.datasets[0].data=[used, Math.max(0,cap-used)]; oltPieChart.update(); const pctClamped=Math.min(100,pct); by('oltCapText').innerText=cap+' ONU'; by('oltCapBar').style.width=pctClamped+'%'; by('overviewOltPct').innerText=Math.round(pctClamped)+'%'; by('overviewOltBar').style.width=pctClamped+'%'; }
function simIncreaseOnu(n=10){ by('onuInstalled').value=(parseInt(by('onuInstalled').value)||0)+n; updateOlt(); }

// QoS
function qosCategory(value,type){ if(type==='latency'){ if(value<=150) return 'Sangat Baik'; if(value<=300) return 'Baik'; if(value<=450) return 'Buruk'; return 'Sangat Buruk'; } if(type==='jitter'){ if(value<=20) return 'Sangat Baik'; if(value<=50) return 'Baik'; return 'Buruk'; } if(type==='loss'){ if(value<=1) return 'Sangat Baik'; if(value<=2.5) return 'Baik'; if(value<=5) return 'Buruk'; return 'Sangat Buruk'; } }
function score(cat){ if(cat==='Sangat Baik') return 4; if(cat==='Baik') return 3; if(cat==='Buruk') return 2; return 1; }
function computeQoSLabel(lat,j,loss){ let s=0; if(lat<=150) s+=4; else if(lat<=300) s+=3; else if(lat<=450) s+=2; else s+=1; if(j<=20) s+=4; else if(j<=50) s+=3; else s+=2; if(loss<=1) s+=4; else if(loss<=2.5) s+=3; else if(loss<=5) s+=2; else s+=1; const avg=s/3; if(avg>=3.5) return 'Sangat Baik'; if(avg>=2.5) return 'Baik'; if(avg>=1.5) return 'Buruk'; return 'Sangat Buruk'; }

function pushQosSample(lat,j,loss){ const label=new Date().toLocaleTimeString(); qosData.labels.push(label); qosData.latency.push(lat); qosData.jitter.push(j); qosData.loss.push(loss); if(qosData.labels.length>30){ qosData.labels.shift(); qosData.latency.shift(); qosData.jitter.shift(); qosData.loss.shift(); } qosChart.update(); by('qosLast').innerText=nowIso(); by('overviewLat').innerText=lat+'ms'; by('overviewLoss').innerText=loss+'%'; const qosLabel=computeQoSLabel(lat,j,loss); by('overviewQoS').innerText=qosLabel; // update MOS & QoE
  const mos = calcMos(lat,loss); by('overviewMos').innerText=mos.toFixed(2); by('overviewQoe').innerText = mos>=4 ? 'Sangat Baik' : mos>=3.5 ? 'Baik' : mos>=3 ? 'Cukup' : 'Buruk'; }

function applyQosInputs(){ const lat=parseFloat(by('latency').value)||0; const j=parseFloat(by('jitter').value)||0; const loss=parseFloat(by('packetLoss').value)||0; pushQosSample(lat,j,loss); }

function calcMos(lat,loss){ // simple E-Model approximation for packet loss & delay (not full RFC)
  // R-value roughly: 94.2 - (lat/40) - (loss*2.5)
  const R = 94.2 - (lat/40) - (loss*2.5);
  const mos = 1 + (0.035)*R + (R*(R-60)*(100-R))*7e-6; return Math.max(1,Math.min(4.5,mos)); }

// Monitoring
function startMonitoring(){ if(monitoring) return; monitoring=true; by('btnToggleMonitor').innerHTML='<i class="bi bi-stop-fill"></i> Stop Monitor'; monitorInterval=setInterval(()=>{ const baseLat=parseFloat(by('latency').value)||30; const baseJ=parseFloat(by('jitter').value)||5; const baseLoss=parseFloat(by('packetLoss').value)||0.5; const lat=Math.max(1, +(baseLat + (Math.random()-0.5)*12).toFixed(1)); const j=Math.max(0, +(baseJ + (Math.random()-0.5)*6).toFixed(1)); const loss=Math.max(0, +(baseLoss + (Math.random()-0.5)*1.5).toFixed(2)); pushQosSample(lat,j,loss); // random ONT events
    if(Math.random()<0.05){ simulateFault(); } },2000); }
function stopMonitoring(){ monitoring=false; clearInterval(monitorInterval); monitorInterval=null; by('btnToggleMonitor').innerHTML='<i class="bi bi-play-fill"></i> Start Monitor'; }

// ONT table
function renderOntTable(filter='all'){ const tbody=document.querySelector('#ontTable tbody'); tbody.innerHTML=''; const list = JSON.parse(localStorage.getItem('ont_list')||'[]'); ontList=list; let shown=0; list.forEach(ont=>{ if(filter!=='all' && ont.status!==filter) return; const tr=document.createElement('tr'); tr.innerHTML=`<td>${ont.id}</td><td>${ont.customer}</td><td>${ont.port}</td><td>${ont.status}</td><td>${ont.power}</td><td>${ont.los}</td>`; tbody.appendChild(tr); shown++; }); }
function addRandomOnt(){ const id='ONT-'+Math.floor(Math.random()*9000+1000); const obj={id:id,customer:'Cust '+id,port:Math.ceil(Math.random()*16),status:'online',power:(Math.random()*2+3).toFixed(1)+' dBm',los:'no'}; const list=JSON.parse(localStorage.getItem('ont_list')||'[]'); list.unshift(obj); localStorage.setItem('ont_list',JSON.stringify(list)); renderOntTable(by('filterStatus').value); }
function simDown(n=5){ const list=JSON.parse(localStorage.getItem('ont_list')||'[]'); for(let i=0;i<n && i<list.length;i++){ list[i].status='offline'; list[i].los='yes'; } localStorage.setItem('ont_list',JSON.stringify(list)); renderOntTable(by('filterStatus').value); }
function recoverAll(){ const list=JSON.parse(localStorage.getItem('ont_list')||'[]'); list.forEach(o=>{ o.status='online'; o.los='no'; }); localStorage.setItem('ont_list',JSON.stringify(list)); renderOntTable(by('filterStatus').value); }
function simulateFault(){ // mark random ONT offline and push spike
  const list=JSON.parse(localStorage.getItem('ont_list')||'[]'); if(!list.length) return; const idx=Math.floor(Math.random()*list.length); list[idx].status='offline'; list[idx].los='yes'; localStorage.setItem('ont_list',JSON.stringify(list)); renderOntTable(by('filterStatus').value); // spike in packet loss
  const loss = Math.min(10, parseFloat(by('packetLoss').value) + (Math.random()*5+2)); pushQosSample(parseFloat(by('latency').value)+Math.random()*100, parseFloat(by('jitter').value)+Math.random()*30, loss.toFixed(2)); }

// Users admin
function loadUsers(){ const list=JSON.parse(localStorage.getItem('isp_users')||'[]'); users=list; renderUserList(); }
function createUser(){ const name=by('adminUser').value.trim(); const role=by('adminRole').value; if(!name) return alert('Username required'); users.unshift({name,role}); localStorage.setItem('isp_users',JSON.stringify(users)); by('adminUser').value=''; renderUserList(); }
function renderUserList(){ const el=by('userList'); el.innerHTML=''; users.forEach(u=>{ const li=document.createElement('li'); li.className='list-group-item d-flex justify-content-between align-items-center'; li.innerHTML=`<div>${u.name} <small class="small-muted">(${u.role})</small></div><div><button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.name}')">Delete</button></div>`; el.appendChild(li); }); }
function deleteUser(name){ users = users.filter(u=>u.name!==name); localStorage.setItem('isp_users',JSON.stringify(users)); renderUserList(); }

// History & Export
function saveSnapshot(){ const entry={time:nowIso(),bandwidth:by('bandwidth').value,users:by('users').value,oltPct:by('overviewOltPct').innerText,latency:qosData.latency.slice(-1)[0]||by('latency').value,jitter:qosData.jitter.slice(-1)[0]||by('jitter').value,loss:qosData.loss.slice(-1)[0]||by('packetLoss').value}; const hist=JSON.parse(localStorage.getItem('isp_hist')||'[]'); hist.unshift(entry); localStorage.setItem('isp_hist',JSON.stringify(hist)); renderHistory(); }
function renderHistory(){ const hist=JSON.parse(localStorage.getItem('isp_hist')||'[]'); const tbody=document.querySelector('#ontTable tbody'); // history displayed elsewhere if needed }
function exportCsv(){ const hist=JSON.parse(localStorage.getItem('isp_hist')||'[]'); if(!hist.length) return alert('No history'); const header=['Time','Bandwidth','Users','OLT%','Latency','Jitter','Loss']; const rows=hist.map(r=>[r.time,r.bandwidth,r.users,r.oltPct,r.latency,r.jitter,r.loss]); const csv=[header].concat(rows).map(r=>r.map(c=>`"${c}"`).join(',')).join('
'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='isp_history.csv'; a.click(); URL.revokeObjectURL(url); }
function exportXlsx(){ const hist=JSON.parse(localStorage.getItem('isp_hist')||'[]'); if(!hist.length) return alert('No history'); const ws=XLSX.utils.json_to_sheet(hist); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'History'); XLSX.writeFile(wb,'isp_history.xlsx'); }
function exportPdfSnapshot(){ const { jsPDF } = window.jspdf; const doc=new jsPDF(); doc.text('ISP Snapshot',14,20); doc.text(`Time: ${nowIso()}`,14,30); doc.text(`Bandwidth: ${by('bandwidth').value} Mbps`,14,40); doc.text(`Users: ${by('users').value}`,14,50); doc.text(`OLT Util: ${by('overviewOltPct').innerText}`,14,60); doc.text(`Latency: ${qosData.latency.slice(-1)[0]||by('latency').value} ms`,14,70); doc.save('isp_snapshot.pdf'); }

// Events binding
function bindEvents(){ by('btnCalcNetwork').addEventListener('click',calcNetwork); by('btnUpdateOlt').addEventListener('click',updateOlt); by('btnSimIncrease').addEventListener('click',()=>simIncreaseOnu(10)); by('btnSimSpike').addEventListener('click',simulateFault); by('btnApplyQos').addEventListener('click',applyQosInputs); by('btnRandomQos').addEventListener('click',()=>{ by('latency').value=Math.round(10+Math.random()*300); by('jitter').value=Math.round(Math.random()*80); by('packetLoss').value=+(Math.random()*6).toFixed(2); applyQosInputs(); }); by('btnToggleMonitor').addEventListener('click',()=>{ monitoring? stopMonitoring(): startMonitoring(); }); by('btnSaveSnapshot').addEventListener('click',saveSnapshot); by('btnExportCsv')?.addEventListener('click',exportCsv); by('btnExportXlsx')?.addEventListener('click',exportXlsx); by('btnExportPdf')?.addEventListener('click',exportPdfSnapshot); by('btnExportPdf')?.addEventListener('click',exportPdfSnapshot); by('btnExportXlsx')?.addEventListener('click',exportXlsx); by('btnCreateUser').addEventListener('click',createUser); by('btnAddRandomOnt').addEventListener('click',addRandomOnt); by('btnSimDown').addEventListener('click',()=>simDown(5)); by('btnRecoverAll').addEventListener('click',recoverAll); by('filterStatus').addEventListener('change',(e)=>renderOntTable(e.target.value)); by('btnClearHistory').addEventListener('click',()=>{ if(confirm('Clear history?')) localStorage.removeItem('isp_hist'); }); by('toggleTheme').addEventListener('change',()=>{ document.body.classList.toggle('theme-dark', by('toggleTheme').checked); }); by('exportPdf')?.addEventListener('click',exportPdfSnapshot); by('exportXlsx')?.addEventListener('click',exportXlsx);
}

// Init dummy data
function seedOnt(){ const list=[]; for(let i=1;i<=80;i++){ list.push({id:'ONT-'+(1000+i),customer:'Cust-'+(1000+i),port:Math.ceil(i/5),status:Math.random()>0.05?'online':'offline',power:(3+Math.random()*2).toFixed(1)+' dBm',los:Math.random()>0.95?'yes':'no'}); } localStorage.setItem('ont_list',JSON.stringify(list)); }

// Initial run
document.addEventListener('DOMContentLoaded',()=>{ if(!localStorage.getItem('ont_list')) seedOnt(); init(); });

</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
