<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NMS Dashboard — Prototype</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {background:#f5f7fb}
    .card-compact {padding: .6rem}
    .topology {background:#fff;border-radius:10px;padding:10px;height:320px;overflow:auto}
    .device-dot {width:14px;height:14px;border-radius:50%;display:inline-block;margin-right:6px}
    .dot-online{background:#28a745}
    .dot-offline{background:#dc3545}
    .sidebar {min-width:260px}
    .chart-wrap{height:180px}
    pre {white-space:pre-wrap}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="fa-solid fa-network-wired"></i> NMS Prototype</a>
    <div class="d-flex">
      <button id="refreshNow" class="btn btn-outline-light btn-sm me-2">Refresh Now</button>
      <div class="text-white-50 small">Admin</div>
    </div>
  </div>
</nav>

<div class="container-fluid mt-3">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-lg-3 mb-3">
      <div class="card sidebar shadow-sm">
        <div class="card-body">
          <h6>Summary</h6>
          <div class="row text-center">
            <div class="col-6">
              <div class="h2" id="onlineCount">0</div>
              <div class="small">Online Devices</div>
            </div>
            <div class="col-6">
              <div class="h2" id="offlineCount">0</div>
              <div class="small">Offline Devices</div>
            </div>
          </div>

          <hr>
          <h6>Quick Ops</h6>
          <div class="d-grid gap-2">
            <button class="btn btn-sm btn-primary" id="openAddDevice">Add Device</button>
            <button class="btn btn-sm btn-outline-secondary" id="backupConfigs">Backup All Configs</button>
            <button class="btn btn-sm btn-outline-danger" id="clearStorage">Reset Demo</button>
          </div>

          <hr>
          <h6>Alarms</h6>
          <ul class="list-group list-group-flush" id="alarmList" style="max-height:200px;overflow:auto"></ul>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="col-lg-9">
      <div class="row g-3">
        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Network Map & Topology</h5>
                <small class="text-muted">Auto-discovery demo (simulated)</small>
              </div>
              <div class="row mt-3">
                <div class="col-md-8">
                  <div class="topology" id="topologyArea">
                    <!-- Simple topology SVG / Canvas -->
                    <svg width="100%" height="280" id="topoSVG"></svg>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="card-compact">
                    <h6>Device List</h6>
                    <div id="deviceTable" style="max-height:260px;overflow:auto"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6>QoS Panel (Latency & Packet Loss)</h6>
              <div class="chart-wrap"><canvas id="qosChart"></canvas></div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6>Performance (CPU / RAM)</h6>
              <div class="chart-wrap"><canvas id="perfChart"></canvas></div>
            </div>
          </div>
        </div>

        <div class="col-md-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h6>OLT Control Panel (PON)</h6>
              <div class="row">
                <div class="col-md-4">
                  <div class="small text-muted">OLT Summary</div>
                  <div class="mt-2">
                    <div>OLT Name: <strong id="oltName">-</strong></div>
                    <div>Active ONUs: <strong id="onuCount">0</strong></div>
                    <div>Avg Rx Power: <strong id="avgRx">-</strong> dBm</div>
                  </div>
                </div>
                <div class="col-md-8">
                  <div id="onuTable" style="max-height:160px;overflow:auto"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add Device Modal -->
<div class="modal fade" id="deviceModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add / Edit Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="deviceForm">
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input class="form-control" id="dev_name" required>
          </div>
          <div class="mb-2">
            <label class="form-label">IP</label>
            <input class="form-control" id="dev_ip" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Type</label>
            <select class="form-select" id="dev_type">
              <option value="router">Router</option>
              <option value="switch">Switch</option>
              <option value="olt">OLT</option>
              <option value="ap">Access Point</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Vendor</label>
            <input class="form-control" id="dev_vendor">
          </div>
          <div class="mb-2">
            <label class="form-label">Location</label>
            <input class="form-control" id="dev_location">
          </div>
          <input type="hidden" id="dev_id">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="saveDevice">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
// Demo prototype: Simulated NMS dashboard
// Data persistence in localStorage for demo
const STORAGE_KEY = 'nms_demo_devices_v1';

// Sample initial devices if none exist
const sampleDevices = [
  {id:1,name:'Core-RTR-01',ip:'10.0.0.1',type:'router',vendor:'Cisco',location:'DC-1',status:'online',cpu:12,ram:45,latency:2,packet_loss:0},
  {id:2,name:'Switch-Edge-02',ip:'10.0.1.2',type:'switch',vendor:'HPE',location:'Floor-2',status:'online',cpu:22,ram:60,latency:5,packet_loss:0},
  {id:3,name:'OLT-01',ip:'10.0.2.1',type:'olt',vendor:'Huawei',location:'POP-1',status:'online',cpu:18,ram:55,latency:10,packet_loss:0.1},
  {id:4,name:'AP-Store-03',ip:'10.0.3.3',type:'ap',vendor:'Ubiquiti',location:'Store-3',status:'offline',cpu:0,ram:0,latency:0,packet_loss:0}
];

function loadDevices(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(sampleDevices));
    return sampleDevices.slice();
  }
  try{ return JSON.parse(raw);}catch(e){localStorage.removeItem(STORAGE_KEY); return sampleDevices.slice();}
}

function saveDevices(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

let devices = loadDevices();
let alarms = [];

// Helpers
function uid(){return Date.now()+Math.floor(Math.random()*999);} 

// UI render
function renderSummary(){
  const online = devices.filter(d=>d.status==='online').length;
  const offline = devices.length - online;
  document.getElementById('onlineCount').innerText = online;
  document.getElementById('offlineCount').innerText = offline;
}

function renderDeviceTable(){
  const wrap = document.getElementById('deviceTable'); wrap.innerHTML='';
  devices.forEach(d=>{
    const el = document.createElement('div'); el.className='d-flex align-items-center justify-content-between py-1 border-bottom';
    el.innerHTML = `<div><span class='device-dot ${d.status==='online'?'dot-online':'dot-offline'}'></span><strong>${d.name}</strong><div class='small text-muted'>${d.ip} • ${d.vendor} • ${d.location}</div></div>
      <div class='text-end'><button class='btn btn-sm btn-outline-secondary me-1' data-id='${d.id}' onclick='editDevice(${d.id})'><i class='fa-solid fa-pen-to-square'></i></button><button class='btn btn-sm btn-danger' onclick='removeDevice(${d.id})'><i class='fa-solid fa-trash'></i></button></div>`;
    wrap.appendChild(el);
  });
}

function renderAlarms(){
  const list = document.getElementById('alarmList'); list.innerHTML='';
  alarms.slice().reverse().forEach(a=>{
    const li = document.createElement('li'); li.className='list-group-item small';
    li.innerHTML = `<div><strong>[${a.severity.toUpperCase()}]</strong> ${a.text}<div class='text-muted small'>${new Date(a.ts).toLocaleString()}</div></div>`;
    list.appendChild(li);
  });
}

function renderTopology(){
  // Simple SVG layout connecting devices
  const svg = document.getElementById('topoSVG');
  svg.innerHTML='';
  const w = svg.clientWidth; const h = svg.clientHeight;
  // place devices in circular layout
  const centerX = w/2; const centerY = h/2; const R = Math.min(w,h)/3;
  const angleStep = (Math.PI*2)/devices.length;
  devices.forEach((d,i)=>{
    const angle = i*angleStep - Math.PI/2;
    const x = centerX + R*Math.cos(angle);
    const y = centerY + R*Math.sin(angle);
    // lines to center
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',centerX); line.setAttribute('y1',centerY); line.setAttribute('x2',x); line.setAttribute('y2',y);
    line.setAttribute('stroke','#cfd8e3'); line.setAttribute('stroke-width',1);
    svg.appendChild(line);
    // circle
    const circle = document.createElementNS('http://www.w3.org/2000/svg','g');
    circle.innerHTML = `<circle cx='${x}' cy='${y}' r='24' fill='${d.status==='online'?"#e6ffef":"#fff0f0"}' stroke='${d.status==='online'?"#28a745":"#dc3545"}' stroke-width='2'></circle><text x='${x}' y='${y+38}' font-size='11' text-anchor='middle' fill='#374151'>${d.name}</text>`;
    // attach click
    circle.addEventListener('click',()=>{ showDevicePopup(d); });
    svg.appendChild(circle);
  });
  // center
  const centerCircle = document.createElementNS('http://www.w3.org/2000/svg','circle');
  centerCircle.setAttribute('cx',centerX); centerCircle.setAttribute('cy',centerY); centerCircle.setAttribute('r',28);
  centerCircle.setAttribute('fill','#ffffff'); centerCircle.setAttribute('stroke','#0d6efd'); centerCircle.setAttribute('stroke-width',2);
  svg.appendChild(centerCircle);
  const centerText = document.createElementNS('http://www.w3.org/2000/svg','text');
  centerText.setAttribute('x',centerX); centerText.setAttribute('y',centerY+38); centerText.setAttribute('text-anchor','middle'); centerText.setAttribute('font-size','12'); centerText.setAttribute('fill','#374151'); centerText.textContent='NMS Controller';
  svg.appendChild(centerText);
}

function showDevicePopup(d){
  alert(`Device: ${d.name}\nIP: ${d.ip}\nType: ${d.type}\nStatus: ${d.status}\nCPU: ${d.cpu}%\nRAM: ${d.ram}%`);
}

// Device CRUD actions
function openModal(){
  const modal = new bootstrap.Modal(document.getElementById('deviceModal'));
  document.getElementById('deviceForm').reset(); document.getElementById('dev_id').value='';
  modal.show();
}

document.getElementById('openAddDevice').addEventListener('click', ()=> openModal());

document.getElementById('saveDevice').addEventListener('click', ()=>{
  const id = document.getElementById('dev_id').value;
  const name = document.getElementById('dev_name').value.trim();
  const ip = document.getElementById('dev_ip').value.trim();
  const type = document.getElementById('dev_type').value;
  const vendor = document.getElementById('dev_vendor').value.trim();
  const loc = document.getElementById('dev_location').value.trim();
  if(!name||!ip) { alert('Name & IP required'); return; }
  if(id){
    const idx = devices.findIndex(x=>x.id==id); if(idx>-1){ devices[idx] = {...devices[idx],name,ip,type,vendor,location:loc}; }
  } else {
    devices.push({id:uid(),name,ip,type,vendor,location:loc,status:'online',cpu:5,ram:20,latency:1,packet_loss:0});
  }
  saveDevices(devices); renderAll(); bootstrap.Modal.getInstance(document.getElementById('deviceModal')).hide();
});

function editDevice(id){
  const d = devices.find(x=>x.id==id); if(!d) return; openModal();
  document.getElementById('dev_id').value=d.id; document.getElementById('dev_name').value=d.name; document.getElementById('dev_ip').value=d.ip; document.getElementById('dev_type').value=d.type; document.getElementById('dev_vendor').value=d.vendor; document.getElementById('dev_location').value=d.location;
}

function removeDevice(id){ if(!confirm('Delete device?')) return; devices = devices.filter(x=>x.id!=id); saveDevices(devices); renderAll(); }

// Simulated polling and metrics update
function simulateMetrics(){
  devices = devices.map(d=>{
    // randomize cpu/ram a bit if online
    if(d.status==='online'){
      d.cpu = Math.min(95, Math.max(2, Math.round(d.cpu + (Math.random()-0.5)*6)));
      d.ram = Math.min(98, Math.max(6, Math.round(d.ram + (Math.random()-0.5)*8)));
      d.latency = Math.max(1, +(d.latency + (Math.random()-0.5)*3).toFixed(1));
      d.packet_loss = Math.max(0, +(d.packet_loss + (Math.random()-0.5)*0.3).toFixed(2));
      // sometimes drop
      if(Math.random()<0.02){ d.status='offline'; alarms.push({severity:'critical',text:`${d.name} went offline`,ts:Date.now()}); }
    } else {
      if(Math.random()<0.05){ d.status='online'; alarms.push({severity:'info',text:`${d.name} back online`,ts:Date.now()}); d.cpu=5; d.ram=20; }
    }
    // create warnings
    if(d.cpu>85) alarms.push({severity:'warning',text:`High CPU on ${d.name} (${d.cpu}%)`,ts:Date.now()});
    if(d.packet_loss>2) alarms.push({severity:'warning',text:`High packet loss on ${d.name} (${d.packet_loss}%)`,ts:Date.now()});
    return d;
  });
  // trim alarms
  if(alarms.length>200) alarms = alarms.slice(-200);
  saveDevices(devices);
}

// Charts
let qosChart, perfChart;
function initCharts(){
  const qosCtx = document.getElementById('qosChart');
  const perfCtx = document.getElementById('perfChart');
  qosChart = new Chart(qosCtx, { type:'line', data:{labels:[],datasets:[{label:'Avg Latency (ms)', data:[], tension:0.4, fill:false},{label:'Avg Packet Loss (%)', data:[], tension:0.4, fill:false}]}, options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
  perfChart = new Chart(perfCtx, { type:'line', data:{labels:[],datasets:[{label:'Avg CPU (%)', data:[], tension:0.4, fill:false},{label:'Avg RAM (%)', data:[], tension:0.4, fill:false}]}, options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});
}

function updateCharts(){
  const avgLatency = +(devices.reduce((s,d)=>s+(d.latency||0),0)/devices.length).toFixed(2);
  const avgPL = +(devices.reduce((s,d)=>s+(d.packet_loss||0),0)/devices.length).toFixed(2);
  const avgCpu = +(devices.reduce((s,d)=>s+(d.cpu||0),0)/devices.length).toFixed(2);
  const avgRam = +(devices.reduce((s,d)=>s+(d.ram||0),0)/devices.length).toFixed(2);
  const now = new Date().toLocaleTimeString();
  // push to qosChart
  function push(chart, a,b){ chart.data.labels.push(now); chart.data.datasets[0].data.push(a); chart.data.datasets[1].data.push(b); if(chart.data.labels.length>30){ chart.data.labels.shift(); chart.data.datasets.forEach(ds=>{ ds.data.shift(); }); } chart.update(); }
  push(qosChart, avgLatency, avgPL);
  push(perfChart, avgCpu, avgRam);
}

// OLT Panel simulation
function renderOLTPanel(){
  const olt = devices.find(d=>d.type==='olt');
  document.getElementById('oltName').innerText = olt? olt.name : '-';
  const onus = [];
  if(olt){
    // simulate some ONUs
    for(let i=1;i<=8;i++){
      const status = Math.random()<0.1? 'down' : 'up';
      onus.push({id:i,pon:`PON-${Math.ceil(i/4)}`,sn:`ONU-${olt.id}-${i}`,rx: +( -28 + Math.random()*6).toFixed(2),status});
    }
  }
  document.getElementById('onuCount').innerText = onus.filter(o=>o.status==='up').length;
  document.getElementById('avgRx').innerText = onus.length? (onus.reduce((s,o)=>s+o.rx,0)/onus.length).toFixed(2) : '-';
  const table = document.getElementById('onuTable'); table.innerHTML='';
  onus.forEach(o=>{ const row = document.createElement('div'); row.className='d-flex justify-content-between align-items-center py-1 border-bottom'; row.innerHTML = `<div><strong>${o.sn}</strong><div class='small text-muted'>${o.pon} • RX ${o.rx} dBm</div></div><div><span class='badge ${o.status==='up'?'bg-success':'bg-danger'}'>${o.status}</span></div>`; table.appendChild(row); });
}

// periodic refresh
function renderAll(){ renderSummary(); renderDeviceTable(); renderTopology(); renderAlarms(); renderOLTPanel(); }

function heartbeat(){ simulateMetrics(); renderAll(); updateCharts(); }

// initial
initCharts(); renderAll(); updateCharts();

// run heartbeat every 5s
setInterval(heartbeat, 5000);

// refresh now
document.getElementById('refreshNow').addEventListener('click', ()=>{ heartbeat(); alert('Refreshed'); });

// backup configs (demo: export JSON)
document.getElementById('backupConfigs').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(devices,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'nms-devices-backup.json'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('clearStorage').addEventListener('click', ()=>{ if(confirm('Reset demo data?')){ localStorage.removeItem(STORAGE_KEY); devices = loadDevices(); alarms=[]; renderAll(); }});

// allow editing from outside
window.editDevice = editDevice; window.removeDevice = removeDevice; window.showDevicePopup = showDevicePopup;

// expose some data for dev
console.log('NMS Prototype ready — devices loaded:', devices);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
