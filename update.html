<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISP / Network Monitoring Dashboard (Prototype)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background:#f6f8fb; }
    .card { border-radius:12px; }
    .status-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:8px; }
    .up { background:#28a745; }
    .down { background:#dc3545; }
    pre { white-space:pre-wrap; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">Network Control & Monitoring</a>
      <div class="d-flex">
        <button id="btnExport" class="btn btn-outline-primary me-2">Export CSV</button>
        <button id="btnSimulateFail" class="btn btn-outline-danger">Simulate Fail</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row g-3">
      <div class="col-12 col-xl-4">
        <div class="card p-3 shadow-sm">
          <h6>QoS Mini Panel</h6>
          <div class="mb-2">Latency: <span id="latency">—</span> ms</div>
          <div class="mb-2">Jitter: <span id="jitter">—</span> ms</div>
          <div class="mb-2">Packet Loss: <span id="ploss">—</span> %</div>
          <hr>
          <h6>OLT / ONU Ratio</h6>
          <div>OLT: <span id="oltCount">0</span></div>
          <div>ONU: <span id="onuCount">0</span></div>
          <div>Ratio (OLT:ONU) <strong id="ratio">0:0</strong></div>
          <hr>
          <h6>Quick Alerts</h6>
          <ul id="alerts" class="list-group list-group-flush small"></ul>
        </div>
      </div>

      <div class="col-12 col-xl-8">
        <div class="card p-3 shadow-sm mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6>Traffic (simulasi realtime)</h6>
            <small class="text-muted">updates setiap 3s</small>
          </div>
          <canvas id="trafficChart" height="120"></canvas>
        </div>

        <div class="card p-3 shadow-sm">
          <h6>Device Inventory / Monitor</h6>
          <div class="table-responsive">
            <table class="table table-sm align-middle" id="deviceTable">
              <thead class="table-light small">
                <tr>
                  <th>Nama</th>
                  <th>Tipe</th>
                  <th>IP</th>
                  <th>Status</th>
                  <th>Latency</th>
                  <th>Jitter</th>
                  <th>Packet Loss</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

      </div>

      <div class="col-12">
        <div class="card p-3 shadow-sm">
          <h6>Event Log</h6>
          <pre id="logArea" style="height:160px;overflow:auto;background:#fff;padding:12px;border-radius:8px"></pre>
        </div>
      </div>

    </div>
  </div>

<script>
// --- CONFIG START ---
const UPDATE_INTERVAL = 3000; // ms
// Example device list (in production: fetch from backend / DB / SNMP discovery)
let devices = [
  { id:1, name:'OLT-1', type:'OLT', ip:'10.0.0.1' },
  { id:2, name:'BR-OLT-2', type:'OLT', ip:'10.0.0.2' },
  { id:3, name:'ONU-101', type:'ONU', ip:'10.0.10.101' },
  { id:4, name:'ONU-102', type:'ONU', ip:'10.0.10.102' },
  { id:5, name:'Router-CORE', type:'Router', ip:'192.168.1.1' },
  { id:6, name:'AP-01', type:'Access Point', ip:'192.168.1.10' }
];
// --- CONFIG END ---

// State
const state = { traffic: [], alerts: [], logs: [] };

// Utilities
function rand(min, max){ return Math.random()*(max-min)+min }
function now() { return new Date().toLocaleString(); }
function pushLog(text){ state.logs.unshift(`[${now()}] ${text}`); if(state.logs.length>200) state.logs.pop(); renderLogs(); }

// Render functions
function renderDeviceTable(){
  const tbody = document.querySelector('#deviceTable tbody'); tbody.innerHTML='';
  devices.forEach(d=>{
    const tr = document.createElement('tr');
    const status = d._up === false ? 'down' : 'up';
    tr.innerHTML = `
      <td>
        <span class="status-dot ${status==='up'?'up':'down'}"></span>
        <strong>${d.name}</strong>
      </td>
      <td>${d.type}</td>
      <td>${d.ip}</td>
      <td>${status==='up'?'<span class="badge bg-success">UP</span>':'<span class="badge bg-danger">DOWN</span>'}</td>
      <td>${(d.latency||'-').toFixed?d.latency.toFixed(1): (d.latency||'-')}</td>
      <td>${(d.jitter||'-').toFixed?d.jitter.toFixed(1): (d.jitter||'-')}</td>
      <td>${(d.ploss||'-').toFixed?d.ploss.toFixed(2): (d.ploss||'-')}</td>
      <td><button class="btn btn-sm btn-outline-secondary" onclick="showDetails(${d.id})">Detail</button></td>
    `;
    tbody.appendChild(tr);
  })
}

function renderLogs(){ document.getElementById('logArea').textContent = state.logs.join('\n'); }
function renderAlerts(){
  const ul = document.getElementById('alerts'); ul.innerHTML='';
  state.alerts.slice(0,6).forEach(a=>{
    const li = document.createElement('li'); li.className='list-group-item small'; li.textContent = a; ul.appendChild(li);
  })
}

// Traffic Chart
const ctx = document.getElementById('trafficChart');
const trafficChart = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [{ label:'Mbps', data:[], tension:0.4, fill:true, pointRadius:0 }] },
  options: { responsive:true, scales:{ x:{ display:false } }, plugins:{ legend:{ display:false } } }
});

function updateTrafficChart(value){
  const data = trafficChart.data;
  data.labels.push(''); data.datasets[0].data.push(value);
  if(data.labels.length>30){ data.labels.shift(); data.datasets[0].data.shift(); }
  trafficChart.update('none');
}

// Details
function showDetails(id){
  const d = devices.find(x=>x.id===id);
  Swal.fire({ title: d.name, html: `IP: <b>${d.ip}</b><br>Type: <b>${d.type}</b><br>Status: <b>${d._up? 'UP':'DOWN'}</b><br>Latency: <b>${d.latency?d.latency.toFixed(2)+' ms':'-'}</b><br>Jitter: <b>${d.jitter?d.jitter.toFixed(2)+' ms':'-'}</b><br>Packet Loss: <b>${d.ploss?d.ploss.toFixed(2)+'%':'-'}</b>`, width:600 });
}

// Simulate polling (in production replace with fetch('/api/poll') that runs ping/snmp)
let simulateFail = false;
function pollDevices(){
  // calculate OLT/ONU counts
  const oltCount = devices.filter(d=>d.type.toLowerCase().includes('olt')).length;
  const onuCount = devices.filter(d=>d.type.toLowerCase().includes('onu')).length;
  document.getElementById('oltCount').textContent = oltCount;
  document.getElementById('onuCount').textContent = onuCount;
  document.getElementById('ratio').textContent = oltCount+':'+onuCount;

  // QoS metrics overall (aggregate)
  let totalLatency=0, totalJ=0, totalPL=0;
  devices.forEach(d=>{
    // simulate per-device
    if(simulateFail && Math.random()<0.12){ d._up=false; d.latency=0; d.jitter=0; d.ploss=100; pushLog(`${d.name} DOWN (simulated)`); }
    else { d._up=true; d.latency = rand(1,120); d.jitter = rand(0,10); d.ploss = rand(0,2); }
    totalLatency += d.latency; totalJ += d.jitter; totalPL += d.ploss;
  });
  const avgLat = totalLatency/devices.length; const avgJ = totalJ/devices.length; const avgPL = totalPL/devices.length;
  document.getElementById('latency').textContent = avgLat.toFixed(1);
  document.getElementById('jitter').textContent = avgJ.toFixed(1);
  document.getElementById('ploss').textContent = avgPL.toFixed(2);

  // traffic value
  const trafficVal = Math.max(1, Math.round(rand(20,500) + (avgPL>1? -rand(0,80):0)));
  updateTrafficChart(trafficVal);

  // alerts
  state.alerts = [];
  devices.filter(d=>d._up===false).forEach(d=> state.alerts.push(`${d.name} DOWN`));
  devices.filter(d=>d.ploss>1).forEach(d=> state.alerts.push(`${d.name} PacketLoss ${d.ploss.toFixed(2)}%`));
  if(avgLat>80) state.alerts.push('High average latency');
  renderDeviceTable(); renderAlerts();
}

// Buttons
document.getElementById('btnSimulateFail').addEventListener('click', ()=>{
  simulateFail = !simulateFail;
  document.getElementById('btnSimulateFail').textContent = simulateFail? 'Stop Sim Fail' : 'Simulate Fail';
  pushLog(`SimulateFail = ${simulateFail}`);
});
document.getElementById('btnExport').addEventListener('click', ()=>{
  exportCSV();
});

function exportCSV(){
  const rows = [['name','type','ip','status','latency_ms','jitter_ms','packet_loss_pct']];
  devices.forEach(d=> rows.push([d.name,d.type,d.ip,d._up? 'UP':'DOWN',d.latency||'',d.jitter||'',d.ploss||'']));
  const csv = rows.map(r=> r.map(c=> '"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='devices_export.csv'; a.click(); URL.revokeObjectURL(url);
  pushLog('Export CSV generated');
}

// Persistence
function saveState(){ localStorage.setItem('netmon.devices', JSON.stringify(devices)); }
function loadState(){ const d = localStorage.getItem('netmon.devices'); if(d) devices = JSON.parse(d); }

// Init
loadState(); renderDeviceTable(); pollDevices();
setInterval(()=>{ pollDevices(); saveState(); }, UPDATE_INTERVAL);
pushLog('Dashboard started');
</script>

</body>
</html>
